name: Build Windows App (Portable + Installer)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    env:
      APP_NAME: NTFSForensicRecovery
      PYTHON_VERSION: '3.10'   # pytsk3 wheels are most reliable on 3.10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install build dependencies
        shell: cmd
        run: |
          python -m pip install --upgrade pip
          if exist requirements.txt (
            rem Prefer wheels first; fallback to source if needed
            pip install --only-binary=:all: -r requirements.txt || pip install -r requirements.txt
          )
          pip install pyinstaller Pillow

      - name: Verify pytsk3 import
        shell: cmd
        run: python -c "import pytsk3; print('pytsk3 import OK')"

      - name: Prepare a guaranteed-valid icon
        shell: python
        run: |
          import os
          from PIL import Image
          os.makedirs('build', exist_ok=True)
          target = os.path.join('build', 'valid_app.ico')

          candidates = [
              os.path.join('assets', 'app.ico'),
              os.path.join('assets', 'app.png'),
              os.path.join('assets', 'app.jpg'),
              os.path.join('assets', 'app.jpeg'),
          ]

          img = None
          src_used = None
          for c in candidates:
              if os.path.exists(c):
                  try:
                      img = Image.open(c).convert('RGBA')
                      src_used = c
                      break
                  except Exception:
                      img = None

          if img is None:
              # Create a simple blue placeholder icon
              img = Image.new('RGBA', (256, 256), (12, 78, 164, 255))
              src_used = 'GENERATED'

          sizes = [(16,16),(24,24),(32,32),(48,48),(64,64),(128,128),(256,256)]
          img.save(target, sizes=sizes)
          print("Icon prepared at:", target, "| Source:", src_used)

      # -------- Build Portable: One-Folder (recommended) --------
      - name: Build one-folder (GUI)
        shell: cmd
        run: |
          pyinstaller --noconfirm --windowed --name "%APP_NAME%" ^
            --icon build\valid_app.ico ^
            --collect-all pytsk3 ^
            --distpath dist\onefolder ^
            main.py

      - name: Zip one-folder portable
        shell: powershell
        run: |
          Compress-Archive -Path "dist\onefolder\${{ env.APP_NAME }}\*" -DestinationPath "dist\${{ env.APP_NAME }}-portable-onefolder.zip"
          Get-ChildItem dist -Recurse

      - name: Upload one-folder portable
        uses: actions/upload-artifact@v4
        with:
          name: portable-onefolder
          path: dist/${{ env.APP_NAME }}-portable-onefolder.zip
          retention-days: 14

      # -------- Build Portable: One-File (optional) --------
      - name: Build one-file (GUI)
        shell: cmd
        continue-on-error: true
        run: |
          pyinstaller --noconfirm --onefile --windowed --name "%APP_NAME%" ^
            --icon build\valid_app.ico ^
            --collect-all pytsk3 ^
            --distpath dist\onefile ^
            main.py

      - name: Upload one-file portable
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: portable-onefile
          path: dist/onefile/*.exe
          retention-days: 14

      # -------- Build Windows Installer using Inno Setup (optional) --------
      - name: Install Inno Setup
        shell: powershell
        continue-on-error: true
        run: choco install innosetup --yes

      - name: Create Inno Setup script
        shell: powershell
        continue-on-error: true
        run: |
          $script = @"
          [Setup]
          AppName=${{ env.APP_NAME }}
          AppVersion=1.0.0
          DefaultDirName={pf}\${{ env.APP_NAME }}
          DisableDirPage=no
          DefaultGroupName=${{ env.APP_NAME }}
          OutputDir=dist\installer
          OutputBaseFilename=${{ env.APP_NAME }}-Setup
          Compression=lzma
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64
          DisableProgramGroupPage=no
          SetupIconFile=build\valid_app.ico
          UninstallDisplayIcon={app}\${{ env.APP_NAME }}.exe

          [Files]
          Source: "dist\onefolder\${{ env.APP_NAME }}\*"; DestDir: "{app}"; Flags: recursesubdirs

          [Icons]
          Name: "{group}\${{ env.APP_NAME }}"; Filename: "{app}\${{ env.APP_NAME }}.exe"
          Name: "{commondesktop}\${{ env.APP_NAME }}"; Filename: "{app}\${{ env.APP_NAME }}.exe"; Tasks: desktopicon

          [Tasks]
          Name: "desktopicon"; Description: "Create a &desktop icon"; GroupDescription: "Additional icons:"
          "@
          Set-Content -Path installer.iss -Value $script -Encoding ASCII

      - name: Build installer
        shell: powershell
        continue-on-error: true
        run: |
          if (Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe") {
            & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
          } elseif (Get-Command iscc -ErrorAction SilentlyContinue) {
            iscc installer.iss
          } else {
            Write-Host "Inno Setup not found; skipping installer build."
          }

      - name: Upload installer
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: installer
          path: dist/installer/*.exe
          retention-days: 14
